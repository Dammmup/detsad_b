import mongoose from 'mongoose';
import User from '../entities/users/model';
import { hashPassword } from '../utils/hash';

async function resetAllPasswords() {
  try {
    // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    await mongoose.connect(
      process.env.MONGO_URI ||
      process.env.MONGODB_URI ||
      'mongodb+srv://damir:damir@cluster0.ku60i6n.mongodb.net/?retryWrites=true&w=majority&appName=Cluster0'
    );
    
    console.log('üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö');
    
    // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    const users = await User.find({});
    
    if (users.length === 0) {
      console.log('‚ùå –ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö');
      await mongoose.connection.close();
      process.exit(0);
    }
    
    console.log(`üìã –ù–∞–π–¥–µ–Ω–æ ${users.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞—Ä–æ–ª–∏...`);
    
    // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    const defaultPassword = 'password123'; // –í—ã –º–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞ –ª—é–±–æ–π –¥—Ä—É–≥–æ–π –ø–∞—Ä–æ–ª—å
    const defaultPasswordHash = await hashPassword(defaultPassword);
    
    for (const user of users) {
      await User.findByIdAndUpdate(
        user._id,
        { 
          passwordHash: defaultPasswordHash,
          initialPassword: defaultPassword,
          password: defaultPasswordHash // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–∞—Ä–æ–ª—å –≤ –ø–æ–ª–µ password
        },
        { runValidators: false }
      );
      
      console.log(`‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω –ø–∞—Ä–æ–ª—å –¥–ª—è: ${user.fullName} (—Ç–µ–ª–µ—Ñ–æ–Ω: ${user.phone})`);
    }
    
    console.log('\nüéâ –í—Å–µ –ø–∞—Ä–æ–ª–∏ —É—Å–ø–µ—à–Ω–æ —Å–±—Ä–æ—à–µ–Ω—ã!');
    console.log(`üîë –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${defaultPassword}`);
    
    await mongoose.connection.close();
    process.exit(0);
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –ø–∞—Ä–æ–ª–µ–π:', error);
    await mongoose.connection.close();
    process.exit(1);
  }
}

resetAllPasswords();