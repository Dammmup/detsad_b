# Детсад Управление - Бэкенд

Серверная часть системы управления детским садом, обеспечивающая API для фронтенд и мобильных приложений.

## Архитектура

Проект представляет собой REST API сервер, написанный на TypeScript с использованием Node.js и Express. Архитектура построена по принципам Model-View-Controller (MVC) с дополнительными слоями сервисов для бизнес-логики.

### Структура проекта:
- `src/entities/` - основные сущности системы (дети, группы, сотрудники, питание, медицина и т.д.)
- `src/api/` - маршруты API и общие обработчики
- `src/config/` - конфигурационные файлы подключения к базе данных и Firebase
- `scripts/` - скрипты для миграций, пересчета данных и других задач

### Технологии:
- TypeScript, Node.js, Express
- MongoDB (MongoDB Atlas)
- Mongoose ODM
- JWT для аутентификации
- Firebase Admin SDK (пуш-уведомления)
- Telegram Bot API
- Node-cron (запланированные задачи)
- Sentry (мониторинг ошибок)
- Библиотеки: axios, multer, exceljs, pdfkit, docxtemplater, nodemailer

## Сущности

### Пользователи и доступ:
- **Auth** - аутентификация и управление пользователями
- **Groups** - группы детей в детском саду

### Дети:
- **Children** - основная информация о детях
- **ChildAttendance** - посещаемость детей
- **ChildPayment** - оплаты за пребывание детей

### Питание:
- **Food** - модуль управления питанием:
  - DailyMenu - ежедневное меню
  - WeeklyMenuTemplate - шаблоны недельных меню
  - Dishes - блюда
  - MenuItems - элементы меню
  - Products - продукты
  - ProductPurchase - закупки продуктов
  - FoodStockLog - журнал учета продуктов
  - OrganolepticJournal - органолептическая проверка блюд
  - PerishableBrak - акт на порчу продуктов
  - DetergentLog - журнал средств дезинфекции
  - FoodStaffHealth - здоровье сотрудников пищеблока
  - ProductCertificates - сертификаты на продукты

### Медицина:
- **Medicine** - модуль медицинского учета:
  - HealthPassport - медицинские карты
  - ChildHealthPassport - медицинские карты детей
  - MedicalJournals - медицинские журналы
  - ContactInfectionJournal - журнал контактных заболеваний
  - InfectiousDiseasesJournal - журнал инфекционных заболеваний
  - MantouxJournal - журнал проб Манту
  - HelminthJournal - журнал на глисты
  - TubPositiveJournal - журнал положительных проб Манту
  - SomaticJournal - соматические заболевания
  - RiskGroupChildren - дети из групп риска

### Персонал:
- **StaffAttendanceTracking** - учет посещаемости сотрудников
- **StaffShifts** - смены сотрудников
- **Payroll** - зарплаты и расчеты

### Финансы:
- **Rent** - аренда и платежи
- **ChildPayment** - оплаты родителей

### Документооборот:
- **Documents** - документы и генерация документов
- **MainEvents** - основные события

### Дополнительно:
- **Cyclogram** - циклограммы и расписания:
  - ActivityTemplate - шаблоны активностей
  - DailySchedule - ежедневные расписания
- **Settings** - настройки системы
- **Qwen3Chat** - интеграция с ИИ-ассистентом

## Функционал

### Аутентификация и авторизация:
- Регистрация и вход пользователей
- Управление ролями и правами доступа
- JWT токены для безопасного доступа

### Управление детьми:
- Добавление, редактирование и удаление информации о детях
- Учет посещаемости
- Управление оплатами за пребывание

### Управление питанием:
- Создание и редактирование меню
- Учет закупок продуктов
- Контроль качества блюд
- Журналы пищеблока и санитарии
- Генерация отчетов по питанию

### Медицинский учет:
- Ведение медицинских карт
- Учет заболеваний и прививок
- Контроль за здоровьем сотрудников пищеблока
- Журналы инфекционных заболеваний

### Учет персонала:
- Учет рабочего времени сотрудников
- Управление сменами
- Расчет зарплат

### Финансовый учет:
- Управление арендой
- Контроль оплат от родителей
- Автоматизация расчетов

### Интеграции:
- Push-уведомления через Firebase
- Telegram бот для взаимодействия
- ИИ-ассистент для анализа данных

## Переменные окружения (.env)

```env
MONGODB_URI=mongodb+srv://...           # Подключение к MongoDB
JWT_SECRET=your_jwt_secret              # Секрет для токенов
TELEGRAM_BOT_TOKEN=...                  # Токен телеграм-бота
DASHSCOPE_API_KEY=...                   # API ключ для ИИ (Qwen)
FIREBASE_SERVICE_ACCOUNT=...            # JSON конфиг Firebase
CRON_SECRET=...                         # Секрет для запуска cron-задач
SMTP_HOST, SMTP_PORT, SMTP_USER, SMTP_PASS # Настройки почты
VAPID_PUBLIC_KEY, VAPID_PRIVATE_KEY     # Ключи для Web-Push
```

## Развёртывание

Проект оптимизирован для развёртывания на **Vercel**. Конфигурация находится в \`vercel.json\`. Бэкенд работает как Serverless Functions.

## Скрипты

- \`npm run dev\` - запуск в режиме разработки с nodemon
- \`npm run build\` - компиляция TypeScript
- \`npm start\` - запуск скомпилированного проекта
- \`npm run start:fast\` - быстрый запуск через ts-node

## Запланированные задачи (Cron)

Система выполняет автоматические задачи через \`node-cron\`:
- **Утренний отчёт (09:00)**: Статистика посещаемости в Telegram
- **Вечерний отчёт (18:00)**: Итоги дня
- **Расчёт зарплат**: Автоматическое создание ведомостей в конце месяца
- **Генерация платежей**: Создание счетов для родителей 1-го числа
- **Архивация**: Удаление старых логов аудита (TTL 1 год)

---

## Установка и запуск

1. Клонируйте репозиторий
2. Установите зависимости: \`npm install\`
3. Настройте переменные окружения в \`.env\` файле
4. Запустите сервер: \`npm run dev\`

Для более подробной информации по БД смотрите \`DATABASE_SETUP.md\`.
